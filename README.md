# Lab2 复杂DNA序列的比对

丁以恒 23307110269

## Task1  (lab2_1.cpp)

通过对于数据规模、基线以及DNA序列的分析，容易发现这组数据绝大多数DNA都是能正确匹配的。并且通过对评分程序的分析，发现要求提交的query和reference段长度要大于等于30，并且错误率不能超过0.1才有效。考虑一个较长的完全匹配的query和reference段，它可以被分为较短的段，并且这些段也同样完全匹配。所以考虑寻找所有完全匹配的长度为30到60的query和reference段，利用字符串哈希和unordered_map，可以在 $30n$ 的时间复杂度内寻找到这些段，将这些段视作"anchor"。然后采用一个DP来寻找最优的将这些"anchor"进行连接的方式，并求出匹配长度的最大值。整个DP过程可以视作在共 $30n$ 个节点的图上寻找最长路径，本质与图算法相同。

对于DP，记`f[i]`为`query[1~i]`中能完全匹配的子序列的最长长度。转移则是在序列`query[1~i]`的结尾找一个长度为30到60的子串，看是否能在reference中被完全匹配。如果找到子串`query[j~i]`能被完全匹配，就将`f[i]`与`f[j]+i-j`进行比较，如果`f[j]+i-j`更大，则说明这个路径更优，用path记录转移路径，此时将`path[i]=j`。这里`i-60<=j<=i-30`，因此DP时间复杂度也为 $30n$。

之所以取30到60，一是因为长度小于30的序列评分时被视为过短，不得分，因此取30以上，并且30以上任意长度的序列都可以由长为30到60的序列拼出。

整体时间复杂度为$\Theta(n)$。

```
(29769,29829,29770,29830),(29709,29769,29710,29770),(29649,29709,29650,29710),(29589,29649,29590,29650),(29529,29589,29530,29590),(29469,29529,29470,29530),(29409,29469,29410,29470),(29349,29409,29350,29410),(29289,29349,29290,29350),(29229,29289,29230,29290),(29169,29229,29170,29230),(29109,29169,29110,29170),(29049,29109,29050,29110),(28989,29049,28990,29050),(28929,28989,28930,28990),(28869,28929,28870,28930),(28809,28869,28810,28870),(28749,28809,28750,28810),(28689,28749,28690,28750),(28629,28689,28630,28690),(28569,28629,28570,28630),(28509,28569,28510,28570),(28449,28509,28450,28510),(28389,28449,28390,28450),(28329,28389,28330,28390),(28269,28329,28270,28330),(28209,28269,28210,28270),(28149,28209,28150,28210),(28089,28149,28090,28150),(28029,28089,28030,28090),(27969,28029,27970,28030),(27909,27969,27910,27970),(27849,27909,27850,27910),(27789,27849,27790,27850),(27729,27789,27730,27790),(27669,27729,27670,27730),(27613,27669,27614,27670),(27583,27613,27584,27614),(27522,27582,27523,27583),(27462,27522,27463,27523),(27402,27462,27403,27463),(27342,27402,27343,27403),(27282,27342,27283,27343),(27222,27282,27223,27283),(27162,27222,27163,27223),(27102,27162,27103,27163),(27042,27102,27043,27103),(26982,27042,26983,27043),(26922,26982,26923,26983),(26862,26922,26863,26923),(26802,26862,26803,26863),(26742,26802,26743,26803),(26682,26742,26683,26743),(26622,26682,26623,26683),(26562,26622,26563,26623),(26502,26562,26503,26563),(26442,26502,26443,26503),(26382,26442,26383,26443),(26322,26382,26323,26383),(26262,26322,26263,26323),(26202,26262,26203,26263),(26142,26202,26143,26203),(26082,26142,26083,26143),(26022,26082,26023,26083),(25962,26022,25963,26023),(25902,25962,25903,25963),(25842,25902,25843,25903),(25782,25842,25783,25843),(25722,25782,25723,25783),(25662,25722,25663,25723),(25602,25662,25603,25663),(25542,25602,25543,25603),(25482,25542,25483,25543),(25422,25482,25423,25483),(25362,25422,25363,25423),(25302,25362,25303,25363),(25242,25302,25243,25303),(25182,25242,25183,25243),(25122,25182,25123,25183),(25062,25122,25063,25123),(25002,25062,25003,25063),(24942,25002,24943,25003),(24882,24942,24883,24943),(24822,24882,24823,24883),(24762,24822,24763,24823),(24702,24762,24703,24763),(24642,24702,24643,24703),(24582,24642,24583,24643),(24522,24582,24523,24583),(24462,24522,24463,24523),(24402,24462,24403,24463),(24342,24402,24343,24403),(24282,24342,24283,24343),(24222,24282,24223,24283),(24162,24222,24163,24223),(24102,24162,24103,24163),(24042,24102,24043,24103),(23982,24042,23983,24043),(23922,23982,23923,23983),(23862,23922,23863,23923),(23802,23862,23803,23863),(23742,23802,6026,6086),(23682,23742,23683,23743),(23622,23682,6146,6206),(23562,23622,6206,6266),(23502,23562,6266,6326),(23442,23502,6326,6386),(23382,23442,6386,6446),(23322,23382,6446,6506),(23262,23322,6506,6566),(23202,23262,6566,6626),(23142,23202,6626,6686),(23082,23142,6686,6746),(23022,23082,6746,6806),(22962,23022,6806,6866),(22902,22962,6866,6926),(22842,22902,6926,6986),(22782,22842,6986,7046),(22722,22782,7046,7106),(22662,22722,7106,7166),(22602,22662,7166,7226),(22542,22602,7226,7286),(22482,22542,7286,7346),(22422,22482,7346,7406),(22362,22422,7406,7466),(22302,22362,7466,7526),(22242,22302,7526,7586),(22182,22242,7586,7646),(22122,22182,7646,7706),(22062,22122,7706,7766),(22002,22062,7766,7826),(21942,22002,7826,7886),(21882,21942,7886,7946),(21822,21882,7946,8006),(21762,21822,8006,8066),(21702,21762,8066,8126),(21642,21702,8126,8186),(21582,21642,8186,8246),(21522,21582,8246,8306),(21462,21522,8306,8366),(21402,21462,8366,8426),(21342,21402,8426,8486),(21282,21342,8486,8546),(21222,21282,8546,8606),(21162,21222,8606,8666),(21102,21162,8666,8726),(21042,21102,8726,8786),(20982,21042,8786,8846),(20922,20982,8846,8906),(20862,20922,8906,8966),(20802,20862,8966,9026),(20742,20802,9026,9086),(20682,20742,9086,9146),(20622,20682,9146,9206),(20562,20622,9206,9266),(20502,20562,9266,9326),(20442,20502,9326,9386),(20382,20442,9386,9446),(20322,20382,9446,9506),(20262,20322,9506,9566),(20202,20262,9566,9626),(20142,20202,9626,9686),(20082,20142,9686,9746),(20022,20082,9746,9806),(19962,20022,9806,9866),(19902,19962,9866,9926),(19842,19902,9926,9986),(19782,19842,9986,10046),(19722,19782,10046,10106),(19679,19722,10106,10149),(19618,19678,10150,10210),(19558,19618,10210,10270),(19498,19558,10270,10330),(19438,19498,10330,10390),(19378,19438,10390,10450),(19318,19378,10450,10510),(19258,19318,10510,10570),(19198,19258,10570,10630),(19138,19198,10630,10690),(19078,19138,10690,10750),(19018,19078,10750,10810),(18958,19018,10810,10870),(18898,18958,10870,10930),(18838,18898,10930,10990),(18778,18838,10990,11050),(18718,18778,11050,11110),(18658,18718,11110,11170),(18598,18658,11170,11230),(18538,18598,11230,11290),(18478,18538,11290,11350),(18418,18478,11350,11410),(18358,18418,11410,11470),(18298,18358,11470,11530),(18238,18298,11530,11590),(18178,18238,11590,11650),(18118,18178,11650,11710),(18058,18118,11710,11770),(17998,18058,26031,26091),(17938,17998,11830,11890),(17878,17938,11890,11950),(17818,17878,11950,12010),(17758,17818,12010,12070),(17698,17758,12070,12130),(17638,17698,4102,4162),(17578,17638,12190,12250),(17518,17578,12250,12310),(17458,17518,12310,12370),(17398,17458,12370,12430),(17338,17398,12430,12490),(17278,17338,12490,12550),(17218,17278,12550,12610),(17158,17218,12610,12670),(17098,17158,12670,12730),(17038,17098,12730,12790),(16978,17038,12790,12850),(16918,16978,12850,12910),(16858,16918,12910,12970),(16798,16858,12970,13030),(16738,16798,13030,13090),(16678,16738,13090,13150),(16618,16678,13150,13210),(16558,16618,13210,13270),(16498,16558,13270,13330),(16438,16498,13330,13390),(16378,16438,13390,13450),(16318,16378,13450,13510),(16258,16318,13510,13570),(16198,16258,13570,13630),(16138,16198,13630,13690),(16078,16138,13690,13750),(16018,16078,13750,13810),(15958,16018,13810,13870),(15898,15958,13870,13930),(15838,15898,13930,13990),(15778,15838,13990,14050),(15718,15778,14050,14110),(15658,15718,14110,14170),(15598,15658,14170,14230),(15538,15598,14230,14290),(15478,15538,14290,14350),(15418,15478,14350,14410),(15372,15418,14410,14456),(15311,15371,14457,14517),(15251,15311,14517,14577),(15191,15251,14577,14637),(15131,15191,14637,14697),(15071,15131,14697,14757),(15011,15071,14757,14817),(14951,15011,14817,14877),(14891,14951,14877,14937),(14831,14891,14937,14997),(14771,14831,14997,15057),(14711,14771,15057,15117),(14651,14711,15117,15177),(14591,14651,15177,15237),(14531,14591,15237,15297),(14471,14531,15297,15357),(14411,14471,15357,15417),(14351,14411,15417,15477),(14291,14351,15477,15537),(14231,14291,15537,15597),(14171,14231,15597,15657),(14111,14171,15657,15717),(14051,14111,15717,15777),(13991,14051,15777,15837),(13931,13991,15837,15897),(13871,13931,15897,15957),(13811,13871,15957,16017),(13751,13811,16017,16077),(13691,13751,16077,16137),(13631,13691,16137,16197),(13571,13631,16197,16257),(13511,13571,16257,16317),(13451,13511,16317,16377),(13391,13451,16377,16437),(13331,13391,16437,16497),(13271,13331,16497,16557),(13211,13271,16557,16617),(13151,13211,16617,16677),(13091,13151,16677,16737),(13031,13091,16737,16797),(12971,13031,16797,16857),(12911,12971,16857,16917),(12851,12911,16917,16977),(12791,12851,16977,17037),(12731,12791,17037,17097),(12671,12731,17097,17157),(12611,12671,17157,17217),(12551,12611,17217,17277),(12491,12551,17277,17337),(12431,12491,17337,17397),(12371,12431,17397,17457),(12311,12371,17457,17517),(12251,12311,17517,17577),(12191,12251,17577,17637),(12131,12191,17638,17698),(12071,12131,17698,17758),(12011,12071,17758,17818),(11951,12011,17818,17878),(11891,11951,17878,17938),(11831,11891,17938,17998),(11771,11831,17998,18058),(11711,11771,18058,18118),(11651,11711,18118,18178),(11591,11651,18178,18238),(11531,11591,18238,18298),(11471,11531,18298,18358),(11411,11471,18358,18418),(11351,11411,18418,18478),(11291,11351,18478,18538),(11231,11291,18538,18598),(11171,11231,18598,18658),(11111,11171,18658,18718),(11051,11111,18718,18778),(10991,11051,18778,18838),(10931,10991,18838,18898),(10871,10931,18898,18958),(10811,10871,18958,19018),(10751,10811,19018,19078),(10691,10751,19078,19138),(10631,10691,19138,19198),(10571,10631,19198,19258),(10511,10571,19258,19318),(10451,10511,19318,19378),(10391,10451,19378,19438),(10331,10391,19438,19498),(10271,10331,19498,19558),(10211,10271,19558,19618),(10151,10211,19618,19678),(10091,10151,19678,19738),(10031,10091,19738,19798),(9971,10031,19798,19858),(9932,9971,19858,19897),(9871,9931,19898,19958),(9811,9871,19958,20018),(9751,9811,20018,20078),(9691,9751,20078,20138),(9631,9691,20138,20198),(9571,9631,20198,20258),(9511,9571,20258,20318),(9451,9511,20318,20378),(9391,9451,20378,20438),(9331,9391,20438,20498),(9271,9331,20498,20558),(9211,9271,20558,20618),(9151,9211,20618,20678),(9091,9151,20678,20738),(9031,9091,20738,20798),(8971,9031,20798,20858),(8911,8971,20858,20918),(8851,8911,20918,20978),(8791,8851,20978,21038),(8731,8791,21038,21098),(8671,8731,21098,21158),(8611,8671,21158,21218),(8551,8611,21218,21278),(8491,8551,21278,21338),(8431,8491,21338,21398),(8371,8431,21398,21458),(8311,8371,21458,21518),(8251,8311,21518,21578),(8191,8251,21578,21638),(8131,8191,21638,21698),(8071,8131,21698,21758),(8011,8071,21758,21818),(7951,8011,21818,21878),(7891,7951,21878,21938),(7852,7891,21938,21977),(7791,7851,21978,22038),(7731,7791,22038,22098),(7671,7731,22098,22158),(7611,7671,22158,22218),(7551,7611,22218,22278),(7491,7551,22278,22338),(7431,7491,22338,22398),(7371,7431,22398,22458),(7317,7371,22458,22512),(7287,7317,22512,22542),(7226,7286,22543,22603),(7166,7226,22603,22663),(7106,7166,22663,22723),(7046,7106,22723,22783),(6986,7046,22783,22843),(6926,6986,22843,22903),(6866,6926,22903,22963),(6806,6866,22963,23023),(6746,6806,23023,23083),(6686,6746,23083,23143),(6626,6686,23143,23203),(6566,6626,23203,23263),(6506,6566,23263,23323),(6446,6506,23323,23383),(6386,6446,23383,23443),(6326,6386,23443,23503),(6266,6326,23503,23563),(6206,6266,23563,23623),(6146,6206,23623,23683),(6086,6146,6086,6146),(6026,6086,23743,23803),(5966,6026,5966,6026),(5906,5966,5906,5966),(5846,5906,5846,5906),(5786,5846,5786,5846),(5726,5786,5726,5786),(5666,5726,5666,5726),(5606,5666,5606,5666),(5546,5606,5546,5606),(5486,5546,5486,5546),(5426,5486,5426,5486),(5366,5426,5366,5426),(5306,5366,5306,5366),(5248,5306,5248,5306),(5218,5248,5218,5248),(5172,5218,24617,24663),(5112,5172,5112,5172),(5052,5112,5052,5112),(4992,5052,4992,5052),(4932,4992,4932,4992),(4872,4932,4872,4932),(4812,4872,4812,4872),(4752,4812,4752,4812),(4692,4752,4692,4752),(4632,4692,4632,4692),(4572,4632,4572,4632),(4512,4572,4512,4572),(4452,4512,4452,4512),(4392,4452,4392,4452),(4332,4392,4332,4392),(4272,4332,4272,4332),(4212,4272,4212,4272),(4152,4212,4152,4212),(4092,4152,4092,4152),(4032,4092,4032,4092),(3972,4032,3972,4032),(3912,3972,3912,3972),(3852,3912,3852,3912),(3792,3852,3792,3852),(3732,3792,11755,11815),(3672,3732,3672,3732),(3612,3672,3612,3672),(3580,3612,11603,11635),(3520,3580,3520,3580),(3460,3520,3460,3520),(3400,3460,3400,3460),(3340,3400,3340,3400),(3280,3340,3280,3340),(3220,3280,3220,3280),(3160,3220,3160,3220),(3100,3160,3100,3160),(3040,3100,3040,3100),(2980,3040,2980,3040),(2920,2980,2920,2980),(2860,2920,2860,2920),(2800,2860,2800,2860),(2740,2800,2740,2800),(2680,2740,12827,12887),(2620,2680,12887,12947),(2560,2620,2560,2620),(2500,2560,2500,2560),(2440,2500,2440,2500),(2380,2440,2380,2440),(2320,2380,2320,2380),(2260,2320,2260,2320),(2200,2260,2200,2260),(2140,2200,2140,2200),(2080,2140,2080,2140),(2020,2080,2020,2080),(1960,2020,1960,2020),(1900,1960,1900,1960),(1840,1900,1840,1900),(1780,1840,1780,1840),(1720,1780,1720,1780),(1660,1720,1660,1720),(1600,1660,1600,1660),(1540,1600,1540,1600),(1480,1540,1480,1540),(1420,1480,1420,1480),(1360,1420,1360,1420),(1300,1360,1300,1360),(1240,1300,1240,1300),(1180,1240,1180,1240),(1120,1180,1120,1180),(1060,1120,1060,1120),(1000,1060,1000,1060),(940,1000,940,1000),(880,940,880,940),(820,880,820,880),(760,820,760,820),(700,760,700,760),(640,700,640,700),(580,640,580,640),(520,580,520,580),(460,520,460,520),(400,460,400,460),(340,400,340,400),(280,340,280,340),(220,280,220,280),(160,220,160,220),(100,160,100,160),(40,100,40,100),(0,40,0,40),
```



## Task2  (lab2_2.cpp,lab2_3.cpp,lab2_4.cpp)

这个测试点中的突变相较于task1多了很多，几乎已经不存在长度大于30的完全匹配的子串了。因此需要考虑寻找更短的完全匹配子串作为"anchor"，例如10到20（多次尝试后我选择了8到16)。但此时这些''anchor''本身都是不合法的，被判断程序视为"too short"。因此需要将找到的子串进行连接后再输出。

首先将可以直接链接的子串进行链接，即在query上相邻且在reference上也相邻。链接后直接提交可以得到1705分。此时已经形成一些长串，但还有部分短串，可能由于和长串中间有一两个突变而被丢失掉。此时枚举长度小于30被丢失掉的短串，看它是否能被连接到左右两个长串之中，判断方式是连接后计算失配率是否小于0.1，小于则将其连入。如此优化后可以得到1997分。

总体时间复杂度同样为$\Theta(n)$。

在3.cpp中我尝试使用vector对于一个query中的串保存多个reference中匹配的串，以求在连接时更优，但并没有得到提升。

如果想达到更好的匹配效果，可能可以考虑枚举query上的子串，再在reference上的子串中找匹配度最高的串，但复杂度会达到$\Theta(n^3)$。尝试限制枚举query上子串时的长度，可以将复杂度限制在$\Theta(n^2)$。我在4.cpp中尝试了该方案，即在一开始创建"anchor"时不只找完全匹配的串，而是找相似度最高的串，使得初始的"anchor"更长（长度为30-60或者50-100），但结果也并没有更优，匹配长度在1930左右。

```
(0,140,0,140),(140,201,140,201),(202,211,252,261),(211,233,211,233),(233,264,233,264),(264,281,264,281),(281,297,281,297),(297,348,397,448),(348,400,448,500),(400,495,505,600),(507,559,757,809),(559,593,659,693),(593,601,508,516),(601,609,1458,1466),(609,693,709,793),(694,721,694,721),(721,789,721,789),(789,829,689,729),(829,876,729,776),(876,900,826,850),(900,913,687,700),(913,934,616,637),(935,967,733,765),(968,984,616,632),(984,1000,700,716),(1000,1029,700,729),(1030,1102,730,802),(1104,1200,804,900),(1200,1300,900,1000),(1308,1383,908,983),(1383,1394,983,994),(1402,1500,402,500),(1500,1602,1000,1102),(1602,1655,1302,1355),(1655,1693,1355,1393),(1694,1739,1194,1239),(1749,1809,1249,1309),(1809,1880,1109,1180),(1881,1998,1381,1498),(2011,2020,39,48),(2059,2068,696,705),(2137,2145,873,881),(2148,2156,1044,1052),(2277,2285,1257,1265),(2291,2500,1491,1700),
```



## 总结

在突变频率总体较低的情况下，找完全匹配的"anchor"直接进行连接可以得到很好的效果，但在突变频率较高时这个方法会得到很多过短"anchor"，从而损失掉很多匹配。可能需要通过一些方式进行延伸后再连接才能有较好效果。